---

- name: Get os_version from /etc/os-release
  when: ansible_os_family is not defined
  raw: "grep '^VERSION_ID=' /etc/os-release | sed s'/VERSION_ID=//'"
  register: os_version

- name: Get distro name from /etc/os-release
  when: ansible_os_family is not defined
  raw: "grep '^NAME=' /etc/os-release | sed s'/NAME=//'"
  register: distro

- name: Set fact ansible_os_family var to Debian
  when:
    - ansible_os_family is not defined
    - "'Ubuntu' in distro.stdout"
  set_fact:
    ansible_os_family: Debian

- name: Set fact ansible_os_family var to RedHat
  when:
    - ansible_os_family is not defined
    - "'CentOS' in distro.stdout"
  set_fact:
    ansible_os_family: RedHat

- name: Override config file directory for Debian
  when: ansible_os_family == "Debian"
  set_fact:
    system_env_dir: "/etc/default"


- name: common alias
  copy:
    dest: "/etc/profile.d/ll.sh"
    content: "alias ll=\"ls --color -aul\"\n"
    owner: "root"
    group: "root"
    mode: "0644"

- name: /bin/sh is /bin/bash
  file:
    src: "/bin/bash"
    dest: "/bin/sh"
    state: link

# - name: backports repositories are actives
#   apt_repository:
#     repo: "{{ item }}"
#     state: present
#     update_cache: yes
#   with_items:
#     - "deb http://cloudfront.debian.net/debian {{ ansible_distribution_release }}-backports main"
#     - "deb-src http://cloudfront.debian.net/debian {{ ansible_distribution_release }}-backports main"

- include_tasks: update.yml

- name: common packages are installed
  apt:
    pkg: "{{ item }}"
    state: present
  with_items:
    - "rsync"
    - "mosh"
    - "sudo"
    - "curl"
    - "locales"
    - "git"
    - "subversion"
    - "whois"
    - "wget"
    - "strace"
    - "sysstat"
    - "iotop"
    - "iperf"
    - "lsof"
    - "dnsutils"
    - "ngrep"
    - "htop"
    - "netcat"
    - "multitail"
    - "tmux"
    - "tree"
    - "ncdu"
    - "net-tools"
    - "procps"
    - "vim"
    - "jq"
    - "htop"
    - "rsyslog"
    - "logrotate"
    - "unattended-upgrades"
    - "build-essential"
    - "zlib1g-dev"
    - "zlib1g"
    - "libcurl4-openssl-dev"

- include_tasks: ntp.yml
- include_tasks: ssh.yml
# - include_tasks: logs.yml
- include_tasks: dns.yml

# - name: activate modprobe
#   command: modprobe dm_thin_pool
# - name: activate dm_thin_pool
#   command: "echo dm_thin_pool >> /etc/modules"

- meta: flush_handlers
